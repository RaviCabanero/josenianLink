
<ion-header class="modern-header">
  <div class="header-container">
    <div class="header-content">
      <!-- Logo Section -->
      <div class="logo-section">
        <div class="logo-wrapper">
          <div class="university-seal">
            <img src="assets/alumnilogo.webp" alt="USJR Seal" class="header-logo">
            <div class="logo-glow"></div>
          </div>
          <div class="brand-text">
            <h1 class="app-title">
              <span class="josenian-text">JOSENIAN</span>
              <span class="link-text">LINK</span>
            </h1>
            <p class="tagline">Home Feed</p>
          </div>
        </div>
      </div>

      <!-- Actions Section -->
      <div class="actions-section">
        <div class="header-actions">
          <ion-button fill="clear" class="action-btn notification-btn" (click)="navigateToNotifications()">
            <ion-icon name="notifications-outline"></ion-icon>
            <ion-badge *ngIf="unreadNotifications > 0" color="danger" class="notification-badge">{{ unreadNotifications }}</ion-badge>
          </ion-button>
          <ion-button fill="clear" class="action-btn" (click)="navigateToSettings()">
            <ion-icon name="settings-outline"></ion-icon>
          </ion-button>
          <ion-button fill="clear" class="action-btn logout-btn" (click)="logout()">
            <ion-icon name="log-out-outline"></ion-icon>
          </ion-button>
        </div>
      </div>
    </div>
  </div>
</ion-header>

<ion-content class="content-wrapper">
  <!-- Create Post Card -->
  <ion-card class="create-post-card">
    <div class="create-post-header">
      <ion-avatar class="post-avatar">
        <img [src]="userProfile?.photoURL || 'assets/default-avatar.png'" />
      </ion-avatar>
      <div class="post-input-container">
        <ion-textarea
          [(ngModel)]="newPost"
          placeholder="Share something with Josenians..."
          rows="2"
          autoGrow
          maxlength="500"
          class="post-input"
          (ionFocus)="focusPostInput()">
        </ion-textarea>
      </div>
    </div>

    <div class="create-post-footer" *ngIf="showPostInput">
      <!-- Additional options shown when focused -->

      <!-- Image Preview Section -->
      <div class="image-preview-section" *ngIf="selectedImage">
        <div class="image-preview-container">
          <img [src]="selectedImage" alt="Selected image" class="preview-image">
          <ion-button fill="clear" class="remove-image-btn" (click)="removeSelectedImage()">
            <ion-icon name="close-circle" color="danger"></ion-icon>
          </ion-button>
        </div>
      </div>

      <div class="post-actions">
        <div class="action-buttons">
          <ion-button fill="clear" class="action-button" (click)="selectImage()">
            <ion-icon name="image" color="primary"></ion-icon>
            Photo
          </ion-button>
          <ion-button fill="clear" class="action-button">
            <ion-icon name="videocam" color="danger"></ion-icon>
            Video
          </ion-button>
          <ion-button fill="clear" class="action-button" (click)="cancelPost()">
            <ion-icon name="close" color="medium"></ion-icon>
            Cancel
          </ion-button>
        </div>
        <ion-button
          (click)="submitPost()"
          [disabled]="loading || (!newPost.trim() && !selectedImage)"
          class="post-button"
          shape="round">
          {{ loading ? 'Posting...' : 'Post' }}
        </ion-button>
      </div>
    </div>

    <!-- Hidden file input -->
    <input type="file" #fileInput accept="image/*" (change)="onImageSelected($event)" style="display: none;">
  </ion-card>

  <!-- Posts Feed -->
  <div class="posts-feed">
    <ng-container *ngIf="(posts$ | async) as posts; else loadingPosts">
      <div *ngIf="posts.length === 0" class="empty-feed">
        <div class="empty-content">
          <ion-icon name="chatbubbles" class="empty-icon"></ion-icon>
          <h3>Quiet on the Wall</h3>
          <p>Be the first to share something with your fellow Josenians</p>
          <ion-button 
            (click)="showPostInput = true" 
            class="first-post-button"
            shape="round">
            Create First Post
          </ion-button>
        </div>
      </div>

      <!-- Post Item -->
      <ion-card *ngFor="let post of posts" class="post-card">
        <div class="post-header">
          <div class="post-author-clickable" (click)="viewUserProfile(post)">
            <ion-avatar class="post-author-avatar">
              <img [src]="post.authorAvatar || 'assets/default-avatar.png'" />
            </ion-avatar>
            <div class="post-author-info">
              <h3 class="author-name">{{ post.authorName || 'Josenian Alumni' }}</h3>
              <p class="post-time">{{ getTimeAgo(post.timestamp) }}</p>
            </div>
          </div>
          <ion-button
            *ngIf="canDeletePostSync(post)"
            fill="clear"
            class="post-menu"
            (click)="deletePost(post.id)">
            <ion-icon name="ellipsis-horizontal"></ion-icon>
          </ion-button>
        </div>

        <div class="post-content">
          <p *ngIf="post.content">{{ post.content }}</p>

          <!-- Post Image -->
          <div class="post-image-container" *ngIf="post.imageUrl">
            <img [src]="post.imageUrl" alt="Post image" class="post-image" (click)="viewFullImage(post.imageUrl)">
          </div>
        </div>

        <!-- Post Actions -->
        <div class="post-actions">
          <!-- Like Button -->
          <ion-button fill="clear" [class.liked]="isPostLiked(post)" class="post-action" (click)="toggleLike(post)">
            <ion-icon 
              [name]="isPostLiked(post) ? 'heart' : 'heart-outline'">
            </ion-icon>
            <span class="action-count">{{ post.likes || 0 }}</span>
          </ion-button>

          <!-- Comment Button -->
          <ion-button fill="clear" class="post-action" (click)="openComments(post)">
            <ion-icon name="chatbubble-outline"></ion-icon>
            <span class="action-count">{{ post.commentsCount || 0 }}</span>
          </ion-button>

          <!-- Share Button -->
          <ion-button fill="clear" class="post-action" (click)="sharePost(post)">
            <ion-icon name="arrow-redo-outline"></ion-icon>
            <span class="action-count">{{ post.sharesCount || 0 }}</span>
          </ion-button>

          <!-- Link Clicks -->
          <ion-button fill="clear" class="post-action" style="margin-left: auto;" (click)="clickLink(post)">
            <ion-icon name="link-outline" style="color: #057609;"></ion-icon>
            <span style="margin-left: 6px; color: #057609; font-weight: 600;">{{ post.linkClicks || 0 }}</span>
          </ion-button>
        </div>
      </ion-card>
    </ng-container>

    <ng-template #loadingPosts>
      <div class="loading-posts">
        <ion-spinner name="crescent"></ion-spinner>
        <p>Loading community posts...</p>
      </div>
    </ng-template>
  </div>
</ion-content>

<ion-footer class="modern-footer">
  <ion-toolbar>
    <div class="footer-buttons">
      <ion-button fill="clear" routerLink="/home" class="footer-nav-btn active">
        <div class="nav-content">
          <ion-icon name="home"></ion-icon>
          <span class="nav-label">Home</span>
        </div>
      </ion-button>
      <ion-button fill="clear" routerLink="/events" class="footer-nav-btn">
        <div class="nav-content">
          <ion-icon name="calendar"></ion-icon>
          <span class="nav-label">Events</span>
        </div>
      </ion-button>
      <ion-button fill="clear" routerLink="/notifications" class="footer-nav-btn">
        <div class="nav-content">
          <ion-icon name="notifications"></ion-icon>
          <span class="nav-label">Notifications</span>
        </div>
      </ion-button>
      <ion-button fill="clear" routerLink="/profile" class="footer-nav-btn">
        <div class="nav-content">
          <ion-icon name="person"></ion-icon>
          <span class="nav-label">Profile</span>
        </div>
      </ion-button>
      <ion-button fill="clear" routerLink="/messages" class="footer-nav-btn">
        <div class="nav-content">
          <ion-icon name="chatbox-ellipses"></ion-icon>
          <span class="nav-label">Messages</span>
        </div>
      </ion-button>
    </div>
  </ion-toolbar>
</ion-footer>
