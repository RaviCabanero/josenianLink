<ion-header class="custom-header">
  <div class="header-bar">
    <div class="logo-title">
      <strong class="logo-green">JOSENIAN</strong><span class="logo-yellow">LINK</span> ðŸ”—
    </div>
    <div class="header-actions">
      <ion-button fill="clear" class="header-button notification-btn" (click)="navigateToNotifications()">
        <ion-icon name="notifications" slot="icon-only"></ion-icon>
        <ion-badge *ngIf="unreadNotifications > 0" color="danger">{{ unreadNotifications }}</ion-badge>
      </ion-button>
      <ion-button fill="clear" class="header-button" (click)="createTestNotification()">
        <ion-icon name="add" slot="icon-only"></ion-icon>
      </ion-button>
      <ion-button fill="clear" class="header-button" (click)="navigateToSettings()">
        <ion-icon name="settings" slot="icon-only"></ion-icon>
      </ion-button>
      <ion-button fill="clear" class="logout-button" (click)="logout()">
        Log Out
      </ion-button>
    </div>
  </div>
</ion-header>

<ion-content class="content-wrapper">
  <!-- Create Post Card -->
  <ion-card class="create-post-card">
    <div class="create-post-header">
      <ion-avatar class="post-avatar">
        <img [src]="userProfile?.photoURL || 'assets/default-avatar.png'" />
      </ion-avatar>
      <ion-button fill="outline" class="post-prompt" (click)="focusPostInput()">
        Share something with Josenians...
      </ion-button>
    </div>
    
    <div class="create-post-footer" *ngIf="showPostInput">
      <ion-textarea
        [(ngModel)]="newPost"
        placeholder="What's on your mind?"
        rows="3"
        autoGrow
        maxlength="500"
        class="post-input">
      </ion-textarea>
      
      <div class="post-actions">
        <div class="action-buttons">
          <ion-button fill="clear" class="action-button">
            <ion-icon name="image" color="primary"></ion-icon>
            Photo
          </ion-button>
          <ion-button fill="clear" class="action-button">
            <ion-icon name="videocam" color="danger"></ion-icon>
            Video
          </ion-button>
        </div>
        <ion-button 
          (click)="submitPost()" 
          [disabled]="loading || !newPost.trim()"
          class="post-button"
          shape="round">
          {{ loading ? 'Posting...' : 'Post' }}
        </ion-button>
      </div>
    </div>
  </ion-card>

  <!-- Posts Feed -->
  <div class="posts-feed">
    <ng-container *ngIf="(posts$ | async) as posts; else loadingPosts">
      <div *ngIf="posts.length === 0" class="empty-feed">
        <div class="empty-content">
          <ion-icon name="chatbubbles" class="empty-icon"></ion-icon>
          <h3>Quiet on the Wall</h3>
          <p>Be the first to share something with your fellow Josenians</p>
          <ion-button 
            (click)="showPostInput = true" 
            class="first-post-button"
            shape="round">
            Create First Post
          </ion-button>
        </div>
      </div>

      <!-- Post Item -->
      <ion-card *ngFor="let post of posts" class="post-card">
        <div class="post-header">
          <ion-avatar class="post-author-avatar">
            <img [src]="post.authorAvatar || 'assets/default-avatar.png'" />
          </ion-avatar>
          <div class="post-author-info">
            <h3 class="author-name">{{ post.authorName || 'Josenian Alumni' }}</h3>
            <p class="post-time">{{ getTimeAgo(post.timestamp) }}</p>
          </div>
          <ion-button
            *ngIf="canDeletePostSync(post)"
            fill="clear"
            class="post-menu"
            (click)="deletePost(post.id)">
            <ion-icon name="ellipsis-horizontal"></ion-icon>
          </ion-button>
        </div>

        <div class="post-content">
          <p>{{ post.content }}</p>
        </div>

        <!-- Removed like, comment, share, and react count -->

        <div class="post-actions" style="justify-content: flex-end;">
          <ion-button fill="clear" class="post-action" style="margin-left: auto;" (click)="clickLink(post)">
            <ion-icon name="link-outline" style="color: #057609;"></ion-icon>
            <span style="margin-left: 6px; color: #057609; font-weight: 600;">{{ post.linkClicks || 0 }}</span>
          </ion-button>
        </div>
      </ion-card>
    </ng-container>

    <ng-template #loadingPosts>
      <div class="loading-posts">
        <ion-spinner name="crescent"></ion-spinner>
        <p>Loading community posts...</p>
      </div>
    </ng-template>
  </div>
</ion-content>

<ion-footer class="home-footer">
  <ion-toolbar>
    <div class="footer-buttons">
      <ion-button fill="clear" routerLink="/home">
        <ion-icon name="home" slot="icon-only"></ion-icon>
      </ion-button>
      <ion-button fill="clear" routerLink="/alumni">
        <ion-icon name="people" slot="icon-only"></ion-icon>
      </ion-button>
      <!-- QR Code Scanner Button -->
      <ion-button fill="clear" (click)="openQrScannerModal()">
        <ion-icon name="qr-code-outline" slot="icon-only"></ion-icon>
      </ion-button>
      <ion-button fill="clear" routerLink="/profile" class="active">
        <ion-icon name="person" slot="icon-only"></ion-icon>
      </ion-button>
      <ion-button fill="clear" routerLink="/messages">
        <ion-icon name="chatbox-ellipses" slot="icon-only"></ion-icon>
      </ion-button>
    </div>
  </ion-toolbar>
</ion-footer>

<!-- QR Code Scanner Modal -->
<ion-modal [isOpen]="isQrScannerModalOpen" (didDismiss)="closeQrScannerModal()">
  <ng-template>
    <ion-header>
      <ion-toolbar>
        <ion-title>QR Code Scanner</ion-title>
        <ion-buttons slot="end">
          <ion-button (click)="closeQrScannerModal()">
            <ion-icon name="close"></ion-icon>
          </ion-button>
        </ion-buttons>
      </ion-toolbar>
    </ion-header>
    <ion-content class="qr-scanner-modal-content">
      <div class="qr-scanner-container">
        <!-- You can use a camera plugin here for actual scanning -->
        <ion-input [(ngModel)]="qrText" placeholder="Enter text to generate QR"></ion-input>
        <ion-button expand="block" (click)="generateQrCode()">Generate QR Code</ion-button>
        <div *ngIf="qrCodeUrl">
          <img [src]="qrCodeUrl" alt="QR Code" style="margin-top:16px;max-width:200px;" />
        </div>
      </div>

      <!-- Inside your QR Code Scanner Modal -->
      <div class="qr-scanner-container">
        <input type="file" accept="image/*" (change)="onQrImageSelected($event)" />
        <ion-button expand="block" (click)="scanQrImage()" [disabled]="!selectedQrImage">Scan QR Code</ion-button>
        <div *ngIf="scannedQrText">
          <p>Scanned Text: {{ scannedQrText }}</p>
        </div>
      </div>
    </ion-content>
  </ng-template>
</ion-modal>