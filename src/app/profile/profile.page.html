<ion-header class="custom-header">
  <div class="header-bar">
    <div class="logo-title">
      <strong class="logo-green">JOSENIAN</strong><span class="logo-yellow">LINK</span> ðŸ”—
    </div>
    <ion-button fill="clear" class="logout-button" (click)="logout()">
      Log Out
    </ion-button>
  </div>
</ion-header>

<ion-content class="profile-content">
  <!-- Profile Card -->
  <div class="profile-card">
    <div class="profile-header">
      <img [src]="getUserPhoto()"
           [alt]="user.name"
           class="profile-avatar"
           (error)="onImageError($event)" />
      <div class="profile-basic-info">
        <h2 class="profile-name">{{ user.name }}</h2>
        <p class="profile-id">{{ user.id }}</p>
        <p class="profile-program">{{ user.program }}</p>
      </div>
      <ion-button fill="outline" class="edit-profile-button" (click)="updateProfile()">
        Edit Profile
      </ion-button>
    </div>
  </div>

  <!-- User Details Section -->
  <div class="user-details">
    <div class="detail-row">
      <span class="detail-label">Graduated on {{ user.yearGraduated }}</span>
    </div>
    <div class="detail-row">
      <span class="detail-label">{{ user.email }}</span>
    </div>
    <div class="detail-row">
      <span class="detail-label">{{ user.address }}</span>
    </div>
    <div class="detail-row">
      <span class="detail-label">{{ user.contactNumber }}</span>
    </div>
  </div>

  <!-- Tab Navigation -->
  <div class="tab-navigation">
    <ion-button fill="clear" class="tab-button" [class.active]="activeTab === 'post'" (click)="setActiveTab('post')">
      Post
    </ion-button>
    <ion-button fill="clear" class="tab-button" [class.active]="activeTab === 'employment'" (click)="setActiveTab('employment')">
      Employment History
    </ion-button>
    <ion-button fill="clear" class="tab-button" [class.active]="activeTab === 'activities'" (click)="setActiveTab('activities')">
      My Activities
    </ion-button>
  </div>

  <!-- Post Section -->
  <div class="post-section" *ngIf="activeTab === 'post'">
    <!-- Create Post Button -->
    <div class="create-post-container">
      <ion-button expand="block" fill="outline" class="create-post-btn" (click)="openCreatePostModal()">
        <ion-icon name="add-circle-outline" slot="start"></ion-icon>
        Create Post
      </ion-button>

      <!-- Debug: Refresh Posts Button -->
      <ion-button expand="block" fill="clear" size="small" (click)="loadUserPosts()" style="margin-top: 8px;">
        <ion-icon name="refresh-outline" slot="start"></ion-icon>
        Refresh Posts
      </ion-button>
    </div>

    <!-- User Posts -->
    <div class="posts-list">
      <!-- Loading state -->
      <div *ngIf="userPosts === undefined" class="loading-posts">
        <ion-spinner></ion-spinner>
        <p>Loading posts...</p>
      </div>

      <!-- User created posts -->
      <div class="user-post" *ngFor="let post of userPosts; trackBy: trackByPostId">
        <img [src]="getPostAuthorPhoto(post)"
             [alt]="post.authorName || user.name"
             class="post-avatar"
             (error)="onImageError($event)" />
        <div class="post-content">
          <h4 class="post-author">{{ post.authorName || user.name }}</h4>
          <p class="post-program">{{ post.authorProgram || user.program }}</p>
          <p class="post-text">{{ post.content }}</p>
          <p class="post-timestamp" *ngIf="post.timestamp">
            {{ formatTimestamp(post.timestamp) }}
          </p>
        </div>
        <div class="post-actions">
          <ion-button fill="clear" size="small" (click)="editPost(post)">
            <ion-icon name="create-outline" slot="icon-only"></ion-icon>
          </ion-button>
          <ion-button fill="clear" size="small" (click)="deletePost(post)">
            <ion-icon name="close-outline" slot="icon-only"></ion-icon>
          </ion-button>
        </div>
      </div>

      <!-- Default post if no posts exist -->
      <div class="user-post" *ngIf="userPosts && userPosts.length === 0">
        <img [src]="getUserPhoto()"
             [alt]="user.name"
             class="post-avatar"
             (error)="onImageError($event)" />
        <div class="post-content">
          <h4 class="post-author">{{ user.name }}</h4>
          <p class="post-program">{{ user.program }}</p>
          <p class="post-text">{{ user.postText || 'We have an opportunity for a software engineer at our company. Feel free to get in touch if you\'re interested.' }}</p>
          <p class="post-note">This is a sample post. Create your first post above!</p>
        </div>
      </div>
    </div>
  </div>

  <!-- Employment History Section -->
  <div class="employment-section" *ngIf="activeTab === 'employment'">
    <!-- Add New Job Button -->
    <div class="add-job-container">
      <ion-button expand="block" fill="outline" class="add-job-btn" (click)="openAddJobModal()">
        <ion-icon name="add-circle-outline" slot="start"></ion-icon>
        New Job +
      </ion-button>
    </div>

    <!-- Current Employment -->
    <div class="employment-category" *ngIf="currentJobs.length > 0">
      <h3 class="category-title">Current</h3>
      <div class="job-entry" *ngFor="let job of currentJobs">
        <div class="job-status">
          <span class="status-indicator current"></span>
        </div>
        <div class="job-details">
          <h4 class="company-name">{{ job.companyName }}</h4>
          <p class="work-date">{{ job.startDate }}</p>
          <p class="job-position">{{ job.position }}</p>
          <p class="job-address">{{ job.address }}</p>
          <p class="job-contact">Phone: {{ job.contactNumber }}</p>
          <p class="job-email">{{ job.email }}</p>
        </div>
        <div class="job-actions">
          <ion-button fill="clear" size="small" (click)="editJob(job)">
            <ion-icon name="create-outline" slot="icon-only"></ion-icon>
          </ion-button>
          <ion-button fill="clear" size="small" (click)="deleteJob(job)">
            <ion-icon name="close-outline" slot="icon-only"></ion-icon>
          </ion-button>
        </div>
      </div>
    </div>

    <!-- Past Employment -->
    <div class="employment-category" *ngIf="pastJobs.length > 0">
      <h3 class="category-title">Past</h3>
      <div class="job-entry" *ngFor="let job of pastJobs">
        <div class="job-status">
          <span class="status-indicator past"></span>
        </div>
        <div class="job-details">
          <h4 class="company-name">{{ job.companyName }}</h4>
          <p class="work-date">{{ job.startDate }} - {{ job.endDate }}</p>
          <p class="job-position">{{ job.position }}</p>
          <p class="job-address">{{ job.address }}</p>
          <p class="job-contact">Phone: {{ job.contactNumber }}</p>
          <p class="job-email">{{ job.email }}</p>
        </div>
        <div class="job-actions">
          <ion-button fill="clear" size="small" (click)="editJob(job)">
            <ion-icon name="create-outline" slot="icon-only"></ion-icon>
          </ion-button>
          <ion-button fill="clear" size="small" (click)="deleteJob(job)">
            <ion-icon name="close-outline" slot="icon-only"></ion-icon>
          </ion-button>
        </div>
      </div>
    </div>

    <!-- Empty State -->
    <div class="empty-employment" *ngIf="currentJobs.length === 0 && pastJobs.length === 0">
      <ion-icon name="briefcase-outline" class="empty-icon"></ion-icon>
      <p class="empty-text">No employment history added yet.</p>
      <p class="empty-subtext">Add your current or past work experience above.</p>
    </div>
  </div>

  <!-- Activities Section -->
  <div class="activities-section" *ngIf="activeTab === 'activities'">
    <!-- Events Table -->
    <div class="events-table">
      <div class="table-header">
        <div class="header-cell events-col">EVENTS</div>
        <div class="header-cell date-col">DATE</div>
        <div class="header-cell points-col">POINTS</div>
      </div>

      <div class="table-body">
        <div class="table-row" *ngFor="let activity of userActivities">
          <div class="cell events-cell">
            <div class="event-info">
              <span class="event-name">{{ activity.eventName }}</span>
              <div class="event-badges">
                <span class="badge" *ngFor="let badge of activity.badges" [style.background-color]="badge.color">
                  {{ badge.name }}
                </span>
              </div>
            </div>
          </div>
          <div class="cell date-cell">{{ activity.date | date:'MMM d, yyyy' }}</div>
          <div class="cell points-cell">
            <span class="points-value">{{ activity.points }}</span>
            <span class="points-label">pts</span>
          </div>
        </div>

        <!-- Empty state -->
        <div class="empty-activities" *ngIf="userActivities.length === 0">
          <p class="empty-text">No activities attended yet</p>
          <p class="empty-subtext">Start participating in USJR events to earn points, badges, and level up!</p>
        </div>
      </div>
    </div>

    <!-- Level System -->
    <div class="level-system">
      <div class="level-info">
        <span class="level-label">Level {{ userLevel.current }}</span>
        <span class="points-info">{{ userLevel.currentPoints }}/{{ userLevel.pointsToNext }} pts to next level</span>
      </div>

      <div class="progress-container">
        <div class="progress-bar">
          <div class="progress-fill" [style.width.%]="userLevel.progressPercentage"></div>
        </div>
        <ion-button fill="outline" size="small" class="use-points-btn" (click)="openUsePointsModal()">
          Use Points
        </ion-button>
      </div>
    </div>
  </div>
</ion-content>

<!-- Edit Profile Modal -->
<ion-modal [isOpen]="isEditModalOpen" (didDismiss)="closeEditModal()">
  <ng-template>
    <ion-header>
      <ion-toolbar>
        <ion-title>Edit Profile</ion-title>
        <ion-buttons slot="end">
          <ion-button (click)="closeEditModal()">
            <ion-icon name="close"></ion-icon>
          </ion-button>
        </ion-buttons>
      </ion-toolbar>
    </ion-header>

    <ion-content class="edit-modal-content">
      <div class="edit-form">
        <!-- Profile Photo Section -->
        <div class="photo-section">
          <div class="current-photo">
            <img [src]="editUser.photo" class="edit-avatar" />
            <ion-button fill="clear" class="change-photo-btn" (click)="selectPhoto()">
              <ion-icon name="camera" slot="icon-only"></ion-icon>
            </ion-button>
          </div>
          <input type="file" #fileInput accept="image/*" (change)="onPhotoSelected($event)" style="display: none;">
        </div>

        <!-- Form Fields -->
        <div class="form-fields">
          <ion-item>
            <ion-label position="stacked">Full Name</ion-label>
            <ion-input [(ngModel)]="editUser.name" placeholder="Enter your full name"></ion-input>
          </ion-item>

          <ion-item>
            <ion-label position="stacked">Email</ion-label>
            <ion-input [(ngModel)]="editUser.email" type="email" placeholder="Enter your email"></ion-input>
          </ion-item>

          <ion-item>
            <ion-label position="stacked">Contact Number</ion-label>
            <ion-input [(ngModel)]="editUser.contactNumber" type="tel" placeholder="Enter your contact number"></ion-input>
          </ion-item>

          <ion-item>
            <ion-label position="stacked">Address</ion-label>
            <ion-textarea [(ngModel)]="editUser.address" placeholder="Enter your address" rows="3"></ion-textarea>
          </ion-item>

          <!-- Privacy Setting -->
          <ion-item>
            <ion-label>Profile Privacy</ion-label>
            <ion-toggle [(ngModel)]="editUser.isPublic" slot="end"></ion-toggle>
          </ion-item>
          <p class="privacy-note">
            {{ editUser.isPublic ? 'Your profile is public and visible to all users' : 'Your profile is private and only visible to you' }}
          </p>
        </div>

        <!-- Action Buttons -->
        <div class="modal-buttons">
          <ion-button expand="block" fill="outline" (click)="closeEditModal()">
            Cancel
          </ion-button>
          <ion-button expand="block" (click)="saveProfile()">
            Save Changes
          </ion-button>
        </div>
      </div>
    </ion-content>
  </ng-template>
</ion-modal>

<!-- Create Post Modal -->
<ion-modal [isOpen]="isCreatePostModalOpen" (didDismiss)="closeCreatePostModal()">
  <ng-template>
    <ion-header>
      <ion-toolbar>
        <ion-title>Create Post</ion-title>
        <ion-buttons slot="end">
          <ion-button (click)="closeCreatePostModal()">
            <ion-icon name="close"></ion-icon>
          </ion-button>
        </ion-buttons>
      </ion-toolbar>
    </ion-header>

    <ion-content class="create-post-modal-content">
      <div class="create-post-form">
        <!-- User Info -->
        <div class="post-author-info">
          <img [src]="user.photo" class="author-avatar" />
          <div class="author-details">
            <h4 class="author-name">{{ user.name }}</h4>
            <p class="author-program">{{ user.program }}</p>
          </div>
        </div>

        <!-- Post Content -->
        <div class="post-input-section">
          <ion-textarea
            [(ngModel)]="newPost.content"
            placeholder="What's on your mind?"
            rows="6"
            maxlength="500"
            class="post-textarea">
          </ion-textarea>
          <div class="character-count">
            {{ newPost.content.length || 0 }}/500
          </div>
        </div>

        <!-- Action Buttons -->
        <div class="post-modal-buttons">
          <ion-button expand="block" fill="outline" (click)="closeCreatePostModal()">
            Cancel
          </ion-button>
          <ion-button expand="block" (click)="createPost()" [disabled]="!newPost.content.trim()">
            Post
          </ion-button>
        </div>
      </div>
    </ion-content>
  </ng-template>
</ion-modal>

<!-- Add Job Modal -->
<ion-modal [isOpen]="isAddJobModalOpen" (didDismiss)="closeAddJobModal()">
  <ng-template>
    <ion-header>
      <ion-toolbar>
        <ion-title>{{ editingJob ? 'Edit Employment' : 'Add Employment' }}</ion-title>
        <ion-buttons slot="end">
          <ion-button (click)="closeAddJobModal()">
            <ion-icon name="close"></ion-icon>
          </ion-button>
        </ion-buttons>
      </ion-toolbar>
    </ion-header>

    <ion-content class="add-job-modal-content">
      <div class="add-job-form">
        <!-- Job Type Selection -->
        <div class="job-type-section">
          <ion-segment [(ngModel)]="newJob.type" class="job-type-segment">
            <ion-segment-button value="current">
              <ion-label>Current Job</ion-label>
            </ion-segment-button>
            <ion-segment-button value="past">
              <ion-label>Past Job</ion-label>
            </ion-segment-button>
          </ion-segment>
        </div>

        <!-- Form Fields -->
        <div class="job-form-fields">
          <ion-item>
            <ion-label position="stacked">Company Name *</ion-label>
            <ion-input [(ngModel)]="newJob.companyName" placeholder="Enter company name"></ion-input>
          </ion-item>

          <ion-item>
            <ion-label position="stacked">Position *</ion-label>
            <ion-input [(ngModel)]="newJob.position" placeholder="Enter your job position"></ion-input>
          </ion-item>

          <ion-item>
            <ion-label position="stacked">Start Date *</ion-label>
            <ion-input [(ngModel)]="newJob.startDate" placeholder="e.g., June 2019"></ion-input>
          </ion-item>

          <ion-item *ngIf="newJob.type === 'past'">
            <ion-label position="stacked">End Date *</ion-label>
            <ion-input [(ngModel)]="newJob.endDate" placeholder="e.g., May 2021"></ion-input>
          </ion-item>

          <ion-item>
            <ion-label position="stacked">Workplace Address</ion-label>
            <ion-textarea [(ngModel)]="newJob.address" placeholder="Enter workplace address" rows="2"></ion-textarea>
          </ion-item>

          <ion-item>
            <ion-label position="stacked">Company Contact Number</ion-label>
            <ion-input [(ngModel)]="newJob.contactNumber" type="tel" placeholder="Enter company contact number"></ion-input>
          </ion-item>

          <ion-item>
            <ion-label position="stacked">Company Email</ion-label>
            <ion-input [(ngModel)]="newJob.email" type="email" placeholder="Enter company email"></ion-input>
          </ion-item>
        </div>

        <!-- Action Buttons -->
        <div class="job-modal-buttons">
          <ion-button expand="block" fill="outline" (click)="closeAddJobModal()">
            Cancel
          </ion-button>
          <ion-button expand="block" (click)="addJob()" [disabled]="!isJobFormValid()">
            {{ editingJob ? 'Update' : 'Done' }}
          </ion-button>
        </div>
      </div>
    </ion-content>
  </ng-template>
</ion-modal>

<!-- Edit Post Modal -->
<ion-modal [isOpen]="isEditPostModalOpen" (didDismiss)="closeEditPostModal()">
  <ng-template>
    <ion-header>
      <ion-toolbar>
        <ion-title>Edit Post</ion-title>
        <ion-buttons slot="end">
          <ion-button (click)="closeEditPostModal()">
            <ion-icon name="close"></ion-icon>
          </ion-button>
        </ion-buttons>
      </ion-toolbar>
    </ion-header>

    <ion-content class="edit-post-modal-content">
      <div class="edit-post-form">
        <!-- User Info -->
        <div class="post-author-info">
          <img [src]="user.photo" class="author-avatar" />
          <div class="author-details">
            <h4 class="author-name">{{ user.name }}</h4>
            <p class="author-program">{{ user.program }}</p>
          </div>
        </div>

        <!-- Post Content -->
        <div class="post-input-section">
          <ion-textarea
            [(ngModel)]="editingPost.content"
            placeholder="What's on your mind?"
            rows="6"
            maxlength="500"
            class="post-textarea">
          </ion-textarea>
          <div class="character-count">
            {{ editingPost.content.length || 0 }}/500
          </div>
        </div>

        <!-- Action Buttons -->
        <div class="post-modal-buttons">
          <ion-button expand="block" fill="outline" (click)="closeEditPostModal()">
            Cancel
          </ion-button>
          <ion-button expand="block" (click)="updatePost()" [disabled]="!editingPost.content.trim()">
            Update Post
          </ion-button>
        </div>
      </div>
    </ion-content>
  </ng-template>
</ion-modal>

<ion-footer class="home-footer">
  <ion-toolbar>
    <div class="footer-buttons">
      <ion-button fill="clear" routerLink="/home">
        <ion-icon name="home" slot="icon-only"></ion-icon>
      </ion-button>
      <ion-button fill="clear" routerLink="/alumni">
        <ion-icon name="people" slot="icon-only"></ion-icon>
      </ion-button>
      <ion-button fill="clear" routerLink="/notifications">
        <ion-icon name="notifications" slot="icon-only"></ion-icon>
      </ion-button>
      <ion-button fill="clear" routerLink="/profile" class="active">
        <ion-icon name="person" slot="icon-only"></ion-icon>
      </ion-button>
      <ion-button fill="clear" routerLink="/messages">
        <ion-icon name="chatbox-ellipses" slot="icon-only"></ion-icon>
      </ion-button>
    </div>
  </ion-toolbar>
</ion-footer>
